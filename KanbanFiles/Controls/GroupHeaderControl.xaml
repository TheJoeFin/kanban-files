<UserControl
    x:Class="KanbanFiles.Controls.GroupHeaderControl"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="using:KanbanFiles.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:KanbanFiles.Models"
    xmlns:viewmodels="using:KanbanFiles.ViewModels"
    mc:Ignorable="d"
    d:DataContext="{d:DesignInstance Type=viewmodels:GroupViewModel}">

    <UserControl.Resources>
        <converters:TagColorToBrushConverter x:Key="TagColorToBrushConverter" />
    </UserControl.Resources>

    <Border
        x:Name="HeaderBorder"
        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
        CornerRadius="6"
        Padding="12,8"
        BorderThickness="0"
        CanDrag="True"
        DragStarting="HeaderBorder_DragStarting"
        DropCompleted="HeaderBorder_DropCompleted"
        PointerEntered="HeaderBorder_PointerEntered"
        PointerExited="HeaderBorder_PointerExited">

        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup x:Name="CommonStates">
                <VisualState x:Name="Normal" />
                <VisualState x:Name="PointerOver">
                    <VisualState.Setters>
                        <Setter Target="HeaderBorder.Background" Value="{ThemeResource CardBackgroundFillColorSecondaryBrush}" />
                        <Setter Target="GroupAddTagButton.Opacity" Value="1" />
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>

        <StackPanel Spacing="4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Chevron Icon -->
                <Button Grid.Column="0"
                        x:Name="ChevronButton"
                        Width="32"
                        Height="32"
                        Background="Transparent"
                        BorderThickness="0"
                        Padding="0"
                        Click="ChevronButton_Click"
                        VerticalAlignment="Center">
                    <FontIcon x:Name="ChevronIcon"
                              Glyph="&#xE70D;"
                              FontSize="12"/>
                </Button>

                <!-- Group Name -->
                <Grid Grid.Column="1" 
                      Margin="8,0,0,0"
                      VerticalAlignment="Center">
                    <TextBlock x:Name="NameTextBlock"
                               Text="{Binding Name, Mode=OneWay}"
                               FontSize="14"
                               FontWeight="SemiBold"
                               VerticalAlignment="Center"
                               DoubleTapped="NameTextBlock_DoubleTapped"
                               Visibility="Visible"/>

                    <TextBox x:Name="NameEditTextBox"
                             Text="{Binding Name, Mode=TwoWay}"
                             FontSize="14"
                             FontWeight="SemiBold"
                             VerticalAlignment="Center"
                             Visibility="Collapsed"
                             LostFocus="NameEditTextBox_LostFocus"
                             KeyDown="NameEditTextBox_KeyDown"/>
                </Grid>

                <!-- Item Count Badge -->
                <Border Grid.Column="2"
                        Background="{ThemeResource AccentFillColorDefaultBrush}"
                        CornerRadius="10"
                        Padding="8,2"
                        Margin="8,0"
                        VerticalAlignment="Center">
                    <TextBlock Text="{Binding ItemCount, Mode=OneWay}"
                               FontSize="12"
                               FontWeight="SemiBold"
                               Foreground="White"/>
                </Border>

                <!-- Menu Button -->
                <Button Grid.Column="3"
                        Content="&#xE712;"
                        FontFamily="Segoe MDL2 Assets"
                        Width="32"
                        Height="32"
                        Background="Transparent"
                        BorderThickness="0"
                        VerticalAlignment="Center">
                    <Button.Flyout>
                        <MenuFlyout>
                            <MenuFlyoutItem Text="Rename" 
                                            Icon="Rename"
                                            Click="RenameMenuItem_Click"/>
                            <MenuFlyoutItem Text="Delete" 
                                            Icon="Delete"
                                            Click="DeleteMenuItem_Click"/>
                        </MenuFlyout>
                    </Button.Flyout>
                </Button>
            </Grid>

            <!-- Tags row: pills + add button, right-aligned -->
            <StackPanel
                HorizontalAlignment="Right"
                Margin="0,2,0,0"
                Orientation="Horizontal"
                Spacing="4">

                <ItemsControl
                    VerticalAlignment="Center"
                    ItemsSource="{Binding Tags, Mode=OneWay}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal" Spacing="4" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="models:TagDefinition">
                            <Border
                                Padding="6,1"
                                Background="{x:Bind Color, Converter={StaticResource TagColorToBrushConverter}}"
                                CornerRadius="8"
                                Opacity="0.85">
                                <TextBlock
                                    FontSize="10"
                                    FontWeight="SemiBold"
                                    Foreground="White"
                                    Text="{x:Bind Name}" />
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <Button
                    x:Name="GroupAddTagButton"
                    Width="22"
                    Height="22"
                    Padding="0"
                    VerticalAlignment="Center"
                    Background="Transparent"
                    BorderThickness="0"
                    Click="GroupAddTagButton_Click"
                    Opacity="0"
                    ToolTipService.ToolTip="Manage tags">
                    <FontIcon FontSize="12" Glyph="&#xE1CB;" />
                </Button>
            </StackPanel>
        </StackPanel>
    </Border>
</UserControl>
