<UserControl
    x:Class="KanbanFiles.Views.ItemDetailView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="using:KanbanFiles.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter" />
    </UserControl.Resources>

    <Grid Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!--  Toolbar  -->
        <Grid
            Grid.Row="0"
            Padding="12,8"
            Background="{ThemeResource LayerFillColorDefaultBrush}"
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            BorderThickness="0,0,0,1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!--  Back button and title  -->
            <StackPanel
                Grid.Column="0"
                Orientation="Horizontal"
                Spacing="12">
                <Button
                    x:Name="BackButton"
                    Width="36"
                    Height="36"
                    Padding="0"
                    VerticalAlignment="Center"
                    Background="Transparent"
                    BorderThickness="0"
                    Click="BackButton_Click"
                    ToolTipService.ToolTip="Back to board (Esc)">
                    <FontIcon FontSize="16" Glyph="&#xE72B;" />
                </Button>
                <TextBlock
                    x:Name="TitleText"
                    VerticalAlignment="Center"
                    FontSize="18"
                    FontWeight="SemiBold"
                    Text="{Binding Title, Mode=OneWay}"
                    TextTrimming="CharacterEllipsis" />
            </StackPanel>

            <!--  Formatting toolbar (markdown files only)  -->
            <StackPanel
                Grid.Column="1"
                Margin="24,0,0,0"
                HorizontalAlignment="Left"
                Orientation="Horizontal"
                Spacing="4"
                Visibility="{Binding IsMarkdown, Converter={StaticResource BoolToVisibilityConverter}}">
                <Button
                    Width="32"
                    Height="32"
                    Padding="0"
                    Background="Transparent"
                    BorderThickness="0"
                    Click="BoldButton_Click"
                    ToolTipService.ToolTip="Bold (Ctrl+B)">
                    <FontIcon FontSize="14" Glyph="&#xE8DD;" />
                </Button>
                <Button
                    Width="32"
                    Height="32"
                    Padding="0"
                    Background="Transparent"
                    BorderThickness="0"
                    Click="ItalicButton_Click"
                    ToolTipService.ToolTip="Italic (Ctrl+I)">
                    <FontIcon FontSize="14" Glyph="&#xE8DB;" />
                </Button>
                <Button
                    Width="32"
                    Height="32"
                    Padding="0"
                    Background="Transparent"
                    BorderThickness="0"
                    Click="LinkButton_Click"
                    ToolTipService.ToolTip="Insert Link (Ctrl+K)">
                    <FontIcon FontSize="14" Glyph="&#xE71B;" />
                </Button>
            </StackPanel>

            <!--  Save status and AI toggle (editable files only)  -->
            <StackPanel
                Grid.Column="2"
                Orientation="Horizontal"
                Spacing="8"
                Visibility="{Binding IsEditable, Converter={StaticResource BoolToVisibilityConverter}}">
                <TextBlock
                    x:Name="SaveStatusText"
                    VerticalAlignment="Center"
                    FontSize="12"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                <Button
                    x:Name="SaveButton"
                    Height="32"
                    VerticalAlignment="Center"
                    Click="SaveButton_Click"
                    Content="Save"
                    Style="{StaticResource AccentButtonStyle}"
                    ToolTipService.ToolTip="Save (Ctrl+S)"
                    Visibility="Collapsed" />
                <Border Width="1" Height="20" Margin="4,0" VerticalAlignment="Center"
                        Background="{ThemeResource CardStrokeColorDefaultBrush}" />
                <ToggleButton
                    x:Name="AiToggleButton"
                    Width="36"
                    Height="36"
                    Padding="0"
                    VerticalAlignment="Center"
                    Background="Transparent"
                    BorderThickness="0"
                    Click="AiToggleButton_Click"
                    ToolTipService.ToolTip="Toggle AI Chat">
                    <FontIcon FontSize="16" Glyph="&#xE945;" />
                </ToggleButton>
            </StackPanel>
        </Grid>

        <!--  Split Editor / Preview / AI  -->
        <Grid x:Name="EditorPreviewGrid" Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition x:Name="AiPaneColumn" Width="0" />
            </Grid.ColumnDefinitions>

            <!--  Text Editor (text files only)  -->
            <Grid
                Grid.Column="0"
                Padding="0"
                Visibility="{Binding IsEditable, Converter={StaticResource BoolToVisibilityConverter}}">
                <TextBox
                    x:Name="EditorTextBox"
                    Padding="16"
                    AcceptsReturn="True"
                    BorderThickness="0"
                    CornerRadius="0"
                    FontFamily="Cascadia Code, Consolas, Courier New"
                    FontSize="14"
                    KeyDown="EditorTextBox_KeyDown"
                    ScrollViewer.VerticalScrollBarVisibility="Auto"
                    TextChanged="EditorTextBox_TextChanged"
                    TextWrapping="Wrap" />
            </Grid>

            <!--  Separator (markdown only)  -->
            <Border
                Grid.Column="0"
                Width="1"
                HorizontalAlignment="Right"
                Background="{ThemeResource CardStrokeColorDefaultBrush}"
                Visibility="{Binding IsMarkdown, Converter={StaticResource BoolToVisibilityConverter}}" />

            <!--  Markdown Preview (markdown only)  -->
            <Grid
                Grid.Column="1"
                Padding="0"
                Visibility="{Binding IsMarkdown, Converter={StaticResource BoolToVisibilityConverter}}">
                <WebView2 x:Name="PreviewWebView" Loaded="PreviewWebView_Loaded" />
            </Grid>

            <!--  File Info Panel (non-text files)  -->
            <StackPanel
                Grid.ColumnSpan="2"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Spacing="16"
                Visibility="{Binding IsEditable, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                <FontIcon
                    HorizontalAlignment="Center"
                    FontSize="48"
                    Glyph="&#xE7C3;" />
                <TextBlock
                    FontSize="24"
                    FontWeight="SemiBold"
                    Text="{Binding Title, Mode=OneWay}"
                    TextAlignment="Center" />
                <TextBlock
                    FontSize="14"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    Text="{Binding FileInfoText, Mode=OneWay}"
                    TextAlignment="Center" />
                <Button
                    x:Name="OpenExternalButton"
                    HorizontalAlignment="Center"
                    Click="OpenExternalButton_Click"
                    Content="Open with Default App"
                    Style="{StaticResource AccentButtonStyle}" />
            </StackPanel>

            <!--  AI Chat Pane separator  -->
            <Border
                Grid.Column="1"
                Width="1"
                HorizontalAlignment="Right"
                Background="{ThemeResource CardStrokeColorDefaultBrush}"
                x:Name="AiPaneSeparator"
                Visibility="Collapsed" />

            <!--  AI Chat Pane  -->
            <Grid
                x:Name="AiChatPane"
                Grid.Column="2"
                Background="{ThemeResource LayerFillColorDefaultBrush}"
                Visibility="Collapsed">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!--  AI Pane Header  -->
                <Grid Grid.Row="0" Padding="12,8"
                      BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                      BorderThickness="0,0,0,1">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                        <FontIcon FontSize="14" Glyph="&#xE945;" />
                        <TextBlock VerticalAlignment="Center" FontWeight="SemiBold" Text="AI Chat" />
                    </StackPanel>
                    <Button
                        Grid.Column="1"
                        x:Name="AiClearButton"
                        Width="28" Height="28"
                        Padding="0"
                        Background="Transparent"
                        BorderThickness="0"
                        Click="AiClearButton_Click"
                        ToolTipService.ToolTip="Clear chat">
                        <FontIcon FontSize="12" Glyph="&#xE74D;" />
                    </Button>
                </Grid>

                <!--  Quick Actions  -->
                <StackPanel Grid.Row="1" Padding="8,8,8,4" Spacing="4">
                    <Button
                        x:Name="QuickActionPlanButton"
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Left"
                        Click="QuickActionPlan_Click"
                        Content="ðŸ’¡ Help me plan what to do next"
                        FontSize="12" />
                    <Button
                        x:Name="QuickActionTodayButton"
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Left"
                        Click="QuickActionToday_Click"
                        Content="ðŸ“‹ What can I do on this today?"
                        FontSize="12" />
                </StackPanel>

                <!--  Messages  -->
                <ScrollViewer
                    x:Name="AiMessagesScrollViewer"
                    Grid.Row="2"
                    Padding="8,4">
                    <ItemsControl x:Name="AiMessagesItemsControl">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border
                                    Margin="0,4"
                                    Padding="10,8"
                                    CornerRadius="8"
                                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
                                    <StackPanel Spacing="4">
                                        <TextBlock
                                            FontSize="11"
                                            FontWeight="SemiBold"
                                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                            Text="{Binding Role}" />
                                        <TextBlock
                                            FontSize="13"
                                            IsTextSelectionEnabled="True"
                                            TextWrapping="Wrap"
                                            Text="{Binding Text}" />
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <!--  Status / Loading  -->
                <StackPanel
                    x:Name="AiStatusPanel"
                    Grid.Row="2"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Visibility="Collapsed">
                    <ProgressRing
                        x:Name="AiLoadingRing"
                        Width="32" Height="32"
                        IsActive="False" />
                    <TextBlock
                        x:Name="AiStatusText"
                        Margin="0,8,0,0"
                        FontSize="12"
                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                        TextAlignment="Center" />
                </StackPanel>

                <!--  Input area  -->
                <Grid Grid.Row="3" Padding="8"
                      BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                      BorderThickness="0,1,0,0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!--  Apply button  -->
                    <Button
                        x:Name="AiApplyButton"
                        Grid.Row="0"
                        Margin="0,0,0,6"
                        HorizontalAlignment="Stretch"
                        Click="AiApplyButton_Click"
                        Style="{StaticResource AccentButtonStyle}"
                        Visibility="Collapsed">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <FontIcon FontSize="12" Glyph="&#xE710;" />
                            <TextBlock Text="Append to editor" />
                        </StackPanel>
                    </Button>

                    <Grid Grid.Row="1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <TextBox
                            x:Name="AiInputTextBox"
                            Grid.Column="0"
                            AcceptsReturn="False"
                            KeyDown="AiInputTextBox_KeyDown"
                            PlaceholderText="Ask about this file..."
                            TextWrapping="Wrap" />
                        <Button
                            x:Name="AiSendButton"
                            Grid.Column="1"
                            Width="36" Height="36"
                            Margin="4,0,0,0"
                            Padding="0"
                            VerticalAlignment="Bottom"
                            Click="AiSendButton_Click"
                            Style="{StaticResource AccentButtonStyle}"
                            ToolTipService.ToolTip="Send">
                            <FontIcon FontSize="14" Glyph="&#xE724;" />
                        </Button>
                    </Grid>
                </Grid>
            </Grid>
        </Grid>
    </Grid>
</UserControl>
